---
/**
 * Gallery Component - Astro Wrapper
 * 
 * SSR wrapper that loads images and passes them to the React Gallery component
 * Automatically loads images from gallery/ folder in the same directory
 */
import { Gallery as GalleryClient } from './Gallery';
import { sortImages, getFileName, formatFilename, applyCaptions } from './galleryUtils';
import type { GalleryImage } from './types';

interface Props {
  path?: string;
  reverseSorting?: boolean;
  columns?: {
    min?: number;
    max?: number;
  };
  className?: string;
  images?: GalleryImage[];
}

const props = Astro.props;
const { path, reverseSorting = false, columns = { min: 200, max: 1 }, className, images: propImages } = props;

// Load images at top level
const allImageModules = import.meta.glob(
  '../../../usr/pages/**/gallery/*.{jpg,jpeg,png,gif,webp,avif}',
  { eager: true }
);

// Load captions.json files
const captionsModules = import.meta.glob(
  '../../../usr/pages/**/gallery/captions.json',
  { eager: true }
);

const currentPagePath = path || Astro.url.pathname;
const normalizedPagePath = currentPagePath.replace(/\/$/, '');

const autoLoadedImages: GalleryImage[] = Object.entries(allImageModules)
  .filter(([filepath]) => {
    const match = filepath.match(/\/pages(.+)\/gallery\//);
    if (!match) return false;
    const imagePath = match[1];
    return normalizedPagePath === imagePath;
  })
  .map(([filepath, module]: [string, any]) => {
    const img = module.default;
    const filename = getFileName(filepath);
    return {
      src: img.src,
      thumb: img.src,
      width: img.width,
      height: img.height,
      alt: formatFilename(filename),
      caption: formatFilename(filename)
    } as GalleryImage;
  });

// Load custom captions if available
let customCaptions: Record<string, string> | undefined;
const captionsPath = Object.keys(captionsModules).find(filepath => {
  const match = filepath.match(/\/pages(.+)\/gallery\/captions\.json/);
  return match && match[1] === normalizedPagePath;
});

if (captionsPath) {
  const captionsModule = captionsModules[captionsPath] as any;
  customCaptions = captionsModule.default || captionsModule;
}

const baseImages = (propImages && propImages.length > 0) ? propImages : autoLoadedImages;
const imagesWithCaptions = applyCaptions(baseImages, customCaptions);
const finalImages = reverseSorting ? sortImages(imagesWithCaptions, reverseSorting) : imagesWithCaptions;
---

{finalImages.length > 0 ? (
  <GalleryClient 
    images={finalImages}
    columns={columns}
    className={className}
    client:idle 
  />
) : (
  <div class="gallery-empty">
    <p>No images found. Please provide images via the <code>images</code> prop.</p>
  </div>
)}

<style>
  .gallery-empty {
    padding: 2rem;
    background: #f5f5f5;
    border-radius: 8px;
    text-align: center;
    color: #666;
  }
  
  .gallery-empty code {
    background: #e0e0e0;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
  }
</style>
